<?php
/**
 * @file
 * Code for the main module.
 */

/**
 * Implements hook_menu().
 */
function custom_main_menu() {
  $items = array();

  $items['test'] = array(
    'title' => 'test',
    'description' => 'A test menu item',
    'weight' => 16,
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * A super function.
 */
function custom_main_complex_cache_get_id($conf, $display, $args, $contexts, $pane) {
  $id = 'panels_complex_cache';

  // If the panel is stored in the database it'll have a numeric did value.
  if (is_numeric($display->did)) {
    $id .= ':' . $display->did;
  }
  // Exported panels won't have a numeric did but may have a usable cache_key.
  elseif (!empty($display->cache_key)) {
    $id .= ':' . str_replace('panel_context:', '', $display->cache_key);
  }
  // Alternatively use the css_id.
  elseif (!empty($display->css_id)) {
    $id .= ':' . $display->css_id;
  }
  // Failover to just appending the did, which may be the completely unusable
  // string 'new'.
  else {
    $id .= ':' . $display->did;
  }

  if ($pane) {
    $id .= ':' . $pane->pid;
  }

  if (user_access('view pane admin links')) {
    $id .= ':admin';
  }

  // Get the current node id.
  $id .= ':' . $args[0];

  // Get the current visible lineup.
  global $user;
  $lineup = 'acquisition';
  if (isset($user->data['customer'])) {
    $sub_index = (isset($user->data['customer']->current_subscription_index)) ? $user->data['customer']->current_subscription_index : 0;

    if (isset($user->data['customer']->subscriptions[$sub_index]->subscription->permissions->renewal)
      && $user->data['customer']->subscriptions[$sub_index]->subscription->permissions->renewal) {
      $lineup = 'renewal';
    }
  }
  elseif (isset($_SESSION['customer']['lineup'])) {
    $lineup = strtolower($_SESSION['customer']['lineup']);
  }
  $id .= ':' . $lineup;

  // Get the current dealership.
  $dealer_tid = variable_get('tmobile_customer_dealership_tid', NULL);
  if (!empty($_SESSION['dealership_tid'])) {
    $dealer_tid = $_SESSION['dealership_tid'];
  }
  $id .= ':' . $dealer_tid;

  if (module_exists('locale')) {
    global $language;
    $id .= ':' . $language->language;
  }

  if (!empty($pane->configuration['use_pager']) && !empty($_GET['page'])) {
    $id .= ':p' . check_plain($_GET['page']);
  }

  return $id;
}

/**
 * A super function.
 */
function custom_main_dealership_thank_you() {
  global $user;

  // Confirm what needs to be sent to sugar CRM request as params.
  // That thing needs to add in session variable on order checkout.
  $items = array();
  $order_number = '';
  $status = '';
  if (isset($_SESSION['tmobile_order_entity']['order_response'])
    && $response = json_decode($_SESSION['tmobile_order_entity']['order_response'])) {

    if (!$response->result_code) {
      $data = array(
        'order_number' => $response->order_number,
        'dealer_number' => $_SESSION['dealership_id'],
        'order_type' => $_SESSION['tmobile_order_entity']['order_type'],
        'external_order_reference' => '',
      );

      $order_number = $response->order_number;
      $endpoint = variable_get('tmobile_sugarcrm_integration_order_status', '/rest/dealer/get-order-status');
      $result = tmobile_sugarcrm_request($endpoint, json_encode($data));

      if (!empty($result->data) && $data = json_decode($result->data)) {
        if (!empty($data->orderstatus)) {
          $status_code = strtoupper($data->orderstatus->code);

          if (!empty($data->orderstatus->detailedstatusses->detailedstatus)) {
            // Set the status present in the response.
            $status = $data->orderstatus->detailedstatusses->detailedstatus->status;
            $items = tmobile_dealer_dealership_order_status_message($data->orderstatus->detailedstatusses->detailedstatus);
          }

          // Set the current order status as defined in messages.
          if (isset($messages[$status_code])) {
            $status = $messages[$status_code];
          }
        }
      }
    }
    else {
      $status = ($response->result_code == '20') ? t('The order is not valid') : t('SugarCRM is not available, order will be sent later.');
    }
  }

  $markup = array(
    '#markup' => t('Order status:') . ' ' . $status,
    '#prefix' => '<div class="l-content--inner">',
    '#suffix' => '</div>',
  );

  if (!empty($items)) {
    $markup['#markup'] .= '<br/><br/>' . theme_item_list(array(
        'items' => $items,
        'title' => t('Details'),
        'type' => 'ul',
        'attributes' => array(),
      ));
  }
  if ($order_number) {
    $markup['#markup'] .= '<br/><br/>' . t('Order ID:') . ' ' . $order_number;
  }

  return $markup;
}
